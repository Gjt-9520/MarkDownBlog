---
title: "苍穹外卖-服务端-套餐管理"
date: 2024-06-30
description: ""
cover: https://github.com/Gjt-9520/Resource/blob/main/Blogimage/project/SkyTakeOut/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-%E5%BA%97%E9%93%BA%E8%90%A5%E4%B8%9A%E7%8A%B6%E6%80%81%E8%AE%BE%E7%BD%AE.png?raw=true
tags: ["SpringBoot","Web"]
category: "项目开发"
updated: 2024-07-01
  
top_group_index: 
---

- [sky-take-out-Gitee仓库](https://gitee.com/gjt_1538048299/sky-take-out)

# 分页查询

## 需求分析

## 接口设计

## 代码开发

SetmealController.java:

```java
/**
 * 套餐分页查询
 *
 * @param setmealPageQueryDTO
 * @return
 */
@GetMapping("/page")
@ApiOperation("套餐分页查询")
public Result<PageResult> page(SetmealPageQueryDTO setmealPageQueryDTO) {
    log.info("套餐分页查询:{}", setmealPageQueryDTO);
    PageResult pageResult = setmealService.pageQuery(setmealPageQueryDTO);
    return Result.success(pageResult);
}
```

SetmealService.java:

```java
/**
 * 套餐分页查询
 *
 * @param setmealPageQueryDTO
 * @return
 */
PageResult pageQuery(SetmealPageQueryDTO setmealPageQueryDTO);
```

SetmealServiceImpl.java:

```java
/**
 * 套餐分页查询
 *
 * @param setmealPageQueryDTO
 * @return
 */
@Override
public PageResult pageQuery(SetmealPageQueryDTO setmealPageQueryDTO) {
    PageHelper.startPage(setmealPageQueryDTO.getPage(), setmealPageQueryDTO.getPageSize());
    Page<SetmealVO> page = setmealMapper.pageQuery(setmealPageQueryDTO);
    return new PageResult(page.getTotal(), page.getResult());
}
```

SetmealMapper.java:

```java
/**
 * 套餐分页查询
 *
 * @param setmealPageQueryDTO
 * @return
 */
Page<SetmealVO> pageQuery(SetmealPageQueryDTO setmealPageQueryDTO);
```

SetmealMapper.xml:

```xml
<!--套餐分页查询-->
<select id="pageQuery" resultType="com.sky.vo.SetmealVO">
    select s.*, c.name as categoryName
    from setmeal s
    left outer join category c on s.category_id = c.id
    <where>
        <if test="name != null">
            and s.name like concat('%',#{name},'%')
        </if>
        <if test="categoryId != null">
            and s.category_id = #{categoryId}
        </if>
        <if test="status != null">
            and s.status = #{status}
        </if>
    </where>
    order by s.create_time desc
</select>
```

# 新增套餐

## 需求分析

## 接口设计

## 代码开发

### 根据分类id查询菜品

DishController.java:

```java
/**
 * 根据分类id查询菜品
 *
 * @param categoryId
 * @return
 */
@GetMapping("list")
@ApiOperation("根据分类id查询菜品")
public Result<List<Dish>> list(Long categoryId) {
    log.info("根据分类id查询菜品:{}", categoryId);
    List<Dish> list = dishService.list(categoryId);
    return Result.success(list);
}
```

DishService.java:

```java
/**
 * 根据分类id查询菜品
 *
 * @param categoryId
 * @return
 */
List<Dish> list(Long categoryId);
```

DishServiceImpl.java:

```java
/**
 * 根据分类id查询菜品
 *
 * @param categoryId
 * @return
 */
@Override
public List<Dish> list(Long categoryId) {
    Dish dish=Dish.builder()
            .categoryId(categoryId)
            .status(StatusConstant.ENABLE)
            .build();
    return dishMapper.list(dish);
}
```

DishMapper.java:

```java
/**
 * 动态条件查询菜品
 *
 * @param dish
 * @return
 */
List<Dish> list(Dish dish);
```

DishMapper.xml:

```xml
<!--动态条件查询菜品-->
<select id="list" resultType="com.sky.entity.Dish">
    select * from dish
    <where>
        <if test="name != null">and name like concat('%',#{name},'%')</if>
        <if test="categoryId != null">and category_id = #{categoryId}</if>
        <if test="status != null">and status = #{status}</if>
    </where>
    order by create_time desc
</select>
```

### 新增套餐

SetmealController.java:

```java
/**
 * 新增套餐
 *
 * @param setmealDTO
 * @return
 */
@PostMapping
@ApiOperation("新增套餐")
public Result save(@RequestBody SetmealDTO setmealDTO) {
    log.info("新增套餐:{}", setmealDTO);
    setmealService.saveWithDish(setmealDTO);
    return Result.success();
}
```

SetmealService.java:

```java
/**
 * 新增套餐
 *
 * @param setmealDTO
 */
void saveWithDish(SetmealDTO setmealDTO);
```

SetmealServiceImpl.java:

```java
/**
 * 新增套餐,同时添加套餐和菜品的关系
 *
 * @param setmealDTO
 */
@Override
@Transactional
public void saveWithDish(SetmealDTO setmealDTO) {
    Setmeal setmeal = new Setmeal();
    BeanUtils.copyProperties(setmealDTO, setmeal);
    // 向套餐表插入数据
    setmealMapper.insert(setmeal);
    // 获取生成的套餐id
    Long id = setmeal.getId();
    List<SetmealDish> setmealDishes = setmealDTO.getSetmealDishes();
    setmealDishes.forEach(setmealDish -> {
        setmealDish.setSetmealId(id);
    });
    // 保存套餐和菜品的关系
    setmealDishMapper.insertBatch(setmealDishes);
}
```

SetmealMapper.java:

```java
/**
 * 新增套餐
 *
 * @param setmeal
 */
@AutoFill(OperationType.INSERT)
void insert(Setmeal setmeal);
```

SetmealDishMapper.java:

```java
/**
 * 批量保存套餐和菜品的关系
 *
 * @param setmealDishes
 */
void insertBatch(List<SetmealDish> setmealDishes);
```

SetmealMapper.xml:

```xml
<!--新增套餐-->
<insert id="insert" useGeneratedKeys="true" keyProperty="id">
    insert into setmeal
    (category_id, name, price, status, description, image, create_time, update_time, create_user, update_user)
    values (#{categoryId}, #{name}, #{price}, #{status}, #{description}, #{image}, #{createTime}, #{updateTime},
            #{createUser}, #{updateUser})
</insert>
```

SetmealDishMapper.xml:

```xml
<!--批量保存套餐和菜品的关系-->
<insert id="insertBatch">
    insert into setmeal_dish
    (setmeal_id,dish_id,name,price,copies)
    values
    <foreach collection="setmealDishes" item="sd" separator=",">
        (#{sd.setmealId},#{sd.dishId},#{sd.name},#{sd.price},#{sd.copies})
    </foreach>
</insert>
```

# 批量删除套餐

## 需求分析

## 接口设计

## 代码开发

SetmealController.java:

```java
/**
 * 批量删除套餐
 *
 * @param ids
 * @return
 */
@DeleteMapping
@ApiOperation("批量删除套餐")
public Result delete(@RequestParam List<Long> ids) {
    log.info("批量删除套餐：{}", ids);
    setmealService.deleteBatch(ids);
    return Result.success();
}
```

SetmealService.java:

```java
/**
 * 批量删除套餐
 *
 * @param ids
 */
void deleteBatch(List<Long> ids);
```

SetmealServiceImpl.java:

```java
/**
 * 批量删除套餐
 *
 * @param ids
 */
@Transactional
@Override
public void deleteBatch(List<Long> ids) {
    ids.forEach(id -> {
        Setmeal setmeal = setmealMapper.getById(id);
        if (StatusConstant.ENABLE.equals(setmeal.getStatus())) {
            // 启售中的套餐不能删除
            throw new DeletionNotAllowedException(MessageConstant.SETMEAL_ON_SALE);
        }
    });

    ids.forEach(setmealId -> {
        // 删除套餐表中的数据
        setmealMapper.deleteById(setmealId);
        // 删除套餐菜品关系表中的数据
        setmealDishMapper.deleteBySetmealId(setmealId);
    });
}
```

SetmealMapper.java:

```java
/**
 * 根据id查询套餐
 *
 * @param id
 * @return
 */
@Select("select * from setmeal where id = #{id}")
Setmeal getById(Long id);

/**
 * 根据id删除套餐
 *
 * @param setmealId
 */
@Delete("delete from setmeal where id = #{setmealId}")
void deleteById(Long setmealId);
```

SetmealDishMapper.java:

```java
/**
 * 根据套餐id删除套餐和菜品的关系
 *
 * @param setmealId
 */
@Delete("delete from setmeal_dish where setmeal_id = #{setmealId}")
void deleteBySetmealId(Long setmealId);
```

# 根据id查询套餐

## 需求分析

## 接口设计

## 代码开发

SetmealController.java:

```java
/**
 * 根据id查询套餐,用于修改页面回显数据
 *
 * @param id
 * @return
 */
@GetMapping("/{id}")
@ApiOperation("根据id查询套餐")
public Result<SetmealVO> getById(@PathVariable Long id) {
    log.info("根据id查询套餐:{}", id);
    SetmealVO setmealVO = setmealService.getByIdWithDish(id);
    return Result.success(setmealVO);
}
```

SetmealService.java:

```java
/**
 * 根据id查询套餐和套餐的菜品关系
 *
 * @param id
 * @return
 */
SetmealVO getByIdWithDish(Long id);
```

SetmealServiceImpl.java:

```java
/**
 * 根据id查询套餐和套餐菜品关系
 *
 * @param id
 * @return
 */
public SetmealVO getByIdWithDish(Long id) {
    Setmeal setmeal = setmealMapper.getById(id);
    List<SetmealDish> setmealDishes = setmealDishMapper.getBySetmealId(id);

    SetmealVO setmealVO = new SetmealVO();
    BeanUtils.copyProperties(setmeal, setmealVO);
    setmealVO.setSetmealDishes(setmealDishes);

    return setmealVO;
}
```

SetmealMapper.java:

```java
/**
 * 根据id查询套餐和套餐菜品关系
 *
 * @param setmealId
 * @return
 */
@Select("select * from setmeal_dish where setmeal_id = #{setmealId}")
List<SetmealDish> getBySetmealId(Long setmealId);
```

SetmealMapper.xml:

```xml

```

# 修改套餐

## 需求分析

## 接口设计

## 代码开发

SetmealController.java:

```java
/**
 * 修改套餐
 *
 * @param setmealDTO
 * @return
 */
@PutMapping
@ApiOperation("修改套餐")
public Result update(@RequestBody SetmealDTO setmealDTO) {
    log.info("修改套餐:{}", setmealDTO);
    setmealService.update(setmealDTO);
    return Result.success();
}
```

SetmealService.java:

```java
/**
 * 修改套餐
 *
 * @param setmealDTO
 */
void update(SetmealDTO setmealDTO);
```

SetmealServiceImpl.java:

```java
/**
 * 修改套餐
 *
 * @param setmealDTO
 */
@Transactional
@Override
public void update(SetmealDTO setmealDTO) {
    Setmeal setmeal = new Setmeal();
    BeanUtils.copyProperties(setmealDTO, setmeal);

    // 修改套餐表,执行update
    setmealMapper.update(setmeal);

    // 获取套餐id
    Long setmealId = setmealDTO.getId();

    // 删除套餐和菜品的关联关系,操作setmeal_dish表,执行delete
    setmealDishMapper.deleteBySetmealId(setmealId);

    List<SetmealDish> setmealDishes = setmealDTO.getSetmealDishes();
    setmealDishes.forEach(setmealDish -> {
        setmealDish.setSetmealId(setmealId);
    });
    // 重新插入套餐和菜品的关联关系,操作setmeal_dish表,执行insert
    setmealDishMapper.insertBatch(setmealDishes);
}
```

SetmealMapper.java:

```java
/**
 * 更新套餐表
 * @param setmeal
 */
@AutoFill(value=OperationType.UPDATE)
void update(Setmeal setmeal);
```

SetmealMapper.xml:

```xml
<!--更新套餐-->
<update id="update">
    update setmeal
    <set>
        <if test="name != null">
            name = #{name},
        </if>
        <if test="categoryId != null">
            category_id = #{categoryId},
        </if>
        <if test="price != null">
            price = #{price},
        </if>
        <if test="image != null">
            image = #{image},
        </if>
        <if test="description != null">
            description = #{description},
        </if>
        <if test="status != null">
            status = #{status},
        </if>
        <if test="updateTime != null">
            update_time = #{updateTime},
        </if>
        <if test="updateUser != null">
            update_user = #{updateUser},
        </if>
    </set>
    where id= #{id}
</update>
```

# 套餐启售停售

## 需求分析

## 接口设计

## 代码开发

SetmealController.java:

```java
/**
 * 套餐启售停售
 *
 * @param status
 * @param id
 * @return
 */
@PostMapping("/status/{status}")
@ApiOperation("套餐起售停售")
public Result startOrStop(@PathVariable Integer status, Long id) {
    log.info("套餐:{} 启售停售状态:{}", id, status);
    setmealService.startOrStop(status, id);
    return Result.success();
}
```

SetmealService.java:

```java
/**
 * 套餐启售停售
 *
 * @param status
 * @param id
 */
void startOrStop(Integer status, Long id);
```

SetmealServiceImpl.java:

```java
/**
 * 套餐启售停售
 *
 * @param status
 * @param id
 */
public void startOrStop(Integer status, Long id) {
    //启售套餐时,判断套餐内是否有停售菜品
    if (status == StatusConstant.ENABLE) {
        List<Dish> dishList = dishMapper.getBySetmealId(id);
        if (dishList != null && dishList.size() > 0) {
            dishList.forEach(dish -> {
                if (StatusConstant.DISABLE.equals(dish.getStatus())) {
                    throw new SetmealEnableFailedException(MessageConstant.SETMEAL_ENABLE_FAILED);
                }
            });
        }
    }

    Setmeal setmeal = Setmeal.builder()
            .id(id)
            .status(status)
            .build();
    setmealMapper.update(setmeal);
}
```

SetmealMapper.java:

```java
 /**
 * 根据套餐id查询菜品
 *
 * @param setmealId
 * @return
 */
@Select("select d.* from dish d left join setmeal_dish sd on d.id = sd.dish_id where sd.setmeal_id = #{setmealId}")
List<Dish> getBySetmealId(Long setmealId);
```