---
title: "苍穹外卖-客户端-用户点餐"
date: 2024-07-06
description: ""
cover: https://github.com/Gjt-9520/Resource/blob/main/Blogimage/project/SkyTakeOut/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98.png?raw=true
tags: ["SpringBoot","Web"]
category: "项目开发"
updated: 2024-07-07
  
top_group_index: 
---

- [sky-take-out-Gitee仓库](https://gitee.com/gjt_1538048299/sky-take-out)

# 用户点餐

# 需求分析

![用户点餐-需求分析](../images/苍穹外卖-用户点餐-需求分析.png)

# 用户下单

## 接口设计

![用户下单-接口分析](../images/苍穹外卖-用户点餐-用户下单-接口分析.png)

## 数据库设计

1. 订单表 orders

![数据库设计-订单表](../images/苍穹外卖-用户下单-数据库设计-订单表.png)

2. 订单明细表 order_detail

![数据库设计-订单明细表](../images/苍穹外卖-用户下单-数据库设计-订单明细表.png)

## 代码开发

OrdersSubmitDTO.java:

```java
package com.sky.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
public class OrdersSubmitDTO implements Serializable {
    //地址簿id
    private Long addressBookId;
    //付款方式
    private int payMethod;
    //备注
    private String remark;
    //预计送达时间
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime estimatedDeliveryTime;
    //配送状态  1立即送出  0选择具体时间
    private Integer deliveryStatus;
    //餐具数量
    private Integer tablewareNumber;
    //餐具数量状态  1按餐量提供  0选择具体数量
    private Integer tablewareStatus;
    //打包费
    private Integer packAmount;
    //总金额
    private BigDecimal amount;
}
```

OrderSubmitVO.java:

```java
package com.sky.vo;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderSubmitVO implements Serializable {
    //订单id
    private Long id;
    //订单号
    private String orderNumber;
    //订单金额
    private BigDecimal orderAmount;
    //下单时间
    private LocalDateTime orderTime;
}
```

Orders.java:

```java
package com.sky.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;
import java.math.BigDecimal;
import java.time.LocalDateTime;

/**
 * 订单
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Orders implements Serializable {

    /**
     * 订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消
     */
    public static final Integer PENDING_PAYMENT = 1;
    public static final Integer TO_BE_CONFIRMED = 2;
    public static final Integer CONFIRMED = 3;
    public static final Integer DELIVERY_IN_PROGRESS = 4;
    public static final Integer COMPLETED = 5;
    public static final Integer CANCELLED = 6;

    /**
     * 支付状态 0未支付 1已支付 2退款
     */
    public static final Integer UN_PAID = 0;
    public static final Integer PAID = 1;
    public static final Integer REFUND = 2;

    private static final long serialVersionUID = 1L;

    private Long id;

    //订单号
    private String number;

    //订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消 7退款
    private Integer status;

    //下单用户id
    private Long userId;

    //地址id
    private Long addressBookId;

    //下单时间
    private LocalDateTime orderTime;

    //结账时间
    private LocalDateTime checkoutTime;

    //支付方式 1微信，2支付宝
    private Integer payMethod;

    //支付状态 0未支付 1已支付 2退款
    private Integer payStatus;

    //实收金额
    private BigDecimal amount;

    //备注
    private String remark;

    //用户名
    private String userName;

    //手机号
    private String phone;

    //地址
    private String address;

    //收货人
    private String consignee;

    //订单取消原因
    private String cancelReason;

    //订单拒绝原因
    private String rejectionReason;

    //订单取消时间
    private LocalDateTime cancelTime;

    //预计送达时间
    private LocalDateTime estimatedDeliveryTime;

    //配送状态  1立即送出  0选择具体时间
    private Integer deliveryStatus;

    //送达时间
    private LocalDateTime deliveryTime;

    //打包费
    private int packAmount;

    //餐具数量
    private int tablewareNumber;

    //餐具数量状态  1按餐量提供  0选择具体数量
    private Integer tablewareStatus;
}
```

OrderDetail.java:

```java
package com.sky.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * 订单明细
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderDetail implements Serializable {

    private static final long serialVersionUID = 1L;

    private Long id;

    //名称
    private String name;

    //订单id
    private Long orderId;

    //菜品id
    private Long dishId;

    //套餐id
    private Long setmealId;

    //口味
    private String dishFlavor;

    //数量
    private Integer number;

    //金额
    private BigDecimal amount;

    //图片
    private String image;
}
```

OrderController.java:

```java
/**
 * 用户下单
 *
 * @param ordersSubmitDTO
 * @return
 */
@PostMapping("/submit")
@ApiOperation("用户下单")
public Result<OrderSubmitVO> submit(@RequestBody OrdersSubmitDTO ordersSubmitDTO) {
    log.info("用户下单:{}", ordersSubmitDTO);
    OrderSubmitVO orderSubmitVO = orderService.submitOrder(ordersSubmitDTO);
    return Result.success(orderSubmitVO);
}
```

OrderService.java:

```java
/**
 * 用户下单
 *
 * @param ordersSubmitDTO
 * @return
 */
OrderSubmitVO submitOrder(OrdersSubmitDTO ordersSubmitDTO);
```

OrderServiceImpl.java:

```java
/**
 * 用户下单
 *
 * @param ordersSubmitDTO
 * @return
 */
@Override
@Transactional
public OrderSubmitVO submitOrder(OrdersSubmitDTO ordersSubmitDTO) {
    // 处理各种业务异常(地址簿数据为空、购物车数据为空)
    // 地址簿数据为空
    AddressBook addressBook = addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());
    if (addressBook == null) {
        throw new AddressBookBusinessException(MessageConstant.ADDRESS_BOOK_IS_NULL);
    }
    // 购物车数据为空
    // 查询当前用户的购物车数据
    ShoppingCart shoppingCart = new ShoppingCart();
    Long userId = BaseContext.getCurrentId();
    shoppingCart.setUserId(userId);
    List<ShoppingCart> shoppingCartList = shoppingCartMapper.list(shoppingCart);
    if (shoppingCartList == null || shoppingCartList.size() == 0) {
        throw new ShoppingCartBusinessException(MessageConstant.SHOPPING_CART_IS_NULL);
    }

    // 向订单表插入1条数据
    Orders orders = new Orders();
    BeanUtils.copyProperties(ordersSubmitDTO, orders);
    // 设置下单用户id
    orders.setUserId(userId);
    // 设置下单时间
    orders.setOrderTime(LocalDateTime.now());
    // 设置订单号
    orders.setNumber(String.valueOf(System.currentTimeMillis()));
    // 设置手机号
    orders.setPhone(addressBook.getPhone());
    // 设置收货人
    orders.setConsignee(addressBook.getConsignee());
    // 设置订单状态:待付款
    orders.setStatus(Orders.PENDING_PAYMENT);
    // 设置支付状态:未支付
    orders.setPayStatus(Orders.UN_PAID);
    orderMapper.insert(orders);

    // 向订单明细表插入n条数据
    List<OrderDetail> orderDetailList = new ArrayList<>();
    for (ShoppingCart cart : shoppingCartList) {
        OrderDetail orderDetail = new OrderDetail();
        BeanUtils.copyProperties(cart, orderDetail);
        // 设置订单id
        orderDetail.setOrderId(orders.getId());
        orderDetailList.add(orderDetail);
    }
    orderDetailMapper.insertBatch(orderDetailList);

    // 清空当前用户的购物车数据
    shoppingCartMapper.delete(userId);

    // 封装VO返回结果
    return OrderSubmitVO.builder()
            .id(orders.getId())
            .orderTime(orders.getOrderTime())
            .orderNumber(orders.getNumber())
            .orderAmount(orders.getAmount())
            .build();
}
```

OrderMapper.java:

```java
/**
 * 插入订单表数据
 *
 * @param orders
 */
void insert(Orders orders);
```

OrderMapper.xml:

```xml
<!--插入订单数据-->
<insert id="insert" useGeneratedKeys="true" keyProperty="id">
    insert into orders (number, status, user_id, address_book_id, order_time, checkout_time, pay_method,
                        pay_status, amount, remark, phone, address, user_name, consignee, cancel_reason,
                        rejection_reason, cancel_time, estimated_delivery_time, delivery_status, delivery_time,
                        pack_amount, tableware_number, tableware_status)
    VALUES (#{number}, #{status}, #{userId}, #{addressBookId}, #{orderTime}, #{checkoutTime}, #{payMethod},
            #{payStatus}, #{amount}, #{remark}, #{phone}, #{address}, #{userName}, #{consignee}, #{cancelReason},
            #{rejectionReason}, #{cancelTime}, #{estimatedDeliveryTime}, #{deliveryStatus}, #{deliveryTime},
            #{packAmount}, #{tablewareNumber}, #{tablewareStatus})
</insert>
```

OrderDetailMapper.java:

```java
/**
 * 批量插入订单明细表数据
 *
 * @param orderDetailList
 */
void insertBatch(List<OrderDetail> orderDetailList);
```

OrderDetailMapper.xml:

```xml
<!--批量插入订单明细表数据-->
<insert id="insertBatch">
    insert into order_detail (name, image, order_id, dish_id, setmeal_id, dish_flavor, number, amount)
    VALUES
    <foreach collection="orderDetailList" item="od" separator=",">
        (#{od.name},#{od.image},#{od.orderId},#{od.dishId},#{od.setmealId},#{od.dishFlavor},#{od.number},#{od.amount})
    </foreach>
</insert>
```

# 订单支付

## 接口设计

## 代码开发

OrderController.java:

```java

```

OrderService.java:

```java

```

OrderServiceImpl.java:

```java

```

OrderMapper.java:

```java

```

OrderDetailMapper.java:

```java

```

OrderMapper.xml:

```xml

```

OrderDetailMapper.xml:

```xml

```