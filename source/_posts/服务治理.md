---
title: "服务治理"
date: 2024-07-22
description: ""
cover: https://github.com/Gjt-9520/Resource/blob/main/Bimage-135/Bimage70.jpg?raw=true
tags: ["微服务","SpringCloud","Nacos","OpenFeign"]
category: "学习笔记"
updated: 2024-07-23
  
top_group_index: 
---

# 远程调用存在的问题(服务治理问题)

通过Http请求实现了跨微服务的远程调用,不过这种手动发送Http请求的方式存在一些问题

试想一下,假如商品微服务被调用较多,为了应对更高的并发,进行了多实例部署,如图:

![远程调用存在的问题](../images/远程调用存在的问题.png)

此时,每个item-service的实例其IP或端口不同,问题来了:
- item-service这么多实例,cart-service如何知道每一个实例的地址？
- http请求要写url地址,cart-service服务到底该调用哪个实例呢？
- 如果在运行过程中,某一个item-service实例宕机,cart-service依然在调用该怎么办？
- 如果并发太高,item-service临时多部署了N台实例,cart-service如何知道新实例的地址？

# 注册中心原理

![注册中心原理](../images/注册中心原理.png)

1. 服务治理中的三个角色分别是什么?                    
- 服务提供者:暴露服务接口,供其它服务调用
- 服务消费者:调用其它服务提供的接口
- 注册中心:记录并监控微服务各实例状态,推送服务变更信息

2. 消费者如何知道提供者的地址?                      
服务提供者会在启动时注册自己信息到注册中心,消费者可以从注册中心订阅和拉取服务信息

3. 消费者如何得知服务状态变更?                          
服务提供者通过心跳机制向注册中心报告自己的健康状态,当心跳异常时注册中心会将异常服务剔除,并通知订阅了该服务的消费者

4. 当提供者有多个实例时,消费者该选择哪一个?                         
消费者可以通过负载均衡算法,从多个实例中选择一个

# 注册中心

目前开源的注册中心框架有很多,国内比较常见的有:
- Eureka:Netflix公司出品,目前被集成在SpringCloud当中,一般用于Java应用
- Nacos:Alibaba公司出品,目前被集成在SpringCloudAlibaba中,一般用于Java应用
- Consul:HashiCorp公司出品,目前集成在SpringCloud中,不限制微服务语言

## Nacos

[Nacos官方网站](https://nacos.io/)

### 服务注册

1. 引入nacos discovery依赖

```xml
<!--nacos服务注册发现-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

2. 配置Nacos地址

application.yaml:

```yaml
server:
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.149.127:8848
```

### 服务发现

消费者需要连接nacos以拉取和订阅服务,因此服务发现的前两步与服务注册是一样,后面再加上服务调用即可:

1. 引入nacos discovery依赖                        
... 

2. 配置nacos地址                    
... 

3. 服务发现                        

```java
private final DiscoveryClient discoveryClient;

private void handleCartItems(List<CartVO> vos) {
    // 1.根据服务名称,拉取服务的实例列表
    List<ServiceInstance> instances = discoveryClient.getInstances("item-service");
    // 2.随机负载均衡,挑选一个实例
    ServiceInstance instance = instances.get(RandomUtil.randomInt(instances.size()));
    // 3.获取实例的IP和端口
    URI uri = instance.getUri();
    // ... 略
}
```

#### 范例

CartServiceImpl中查询商品:

```java
// 获取商品id
Set<Long> itemIds = vos.stream().map(CartVO::getItemId).collect(Collectors.toSet());
// 2.查询商品
// List<ItemDTO> items = itemService.queryItemByIds(itemIds);
// 根据服务的名称获取服务的实例列表
List<ServiceInstance> instances = discoveryClient.getInstances("item-service");
if (CollUtil.isEmpty(instances)) {
    return;
}
// 负载均衡,从实例列表中挑选一个实例
ServiceInstance instance = instances.get(RandomUtil.randomInt(instances.size()));
// 利用RestTemplate发起http请求,得到http响应
ResponseEntity<List<ItemDTO>> response = restTemplate.exchange(
        instance.getUri() + "/items?ids={ids}",
        HttpMethod.GET,
        null,
        new ParameterizedTypeReference<List<ItemDTO>>() {
        },
        Map.of("ids", CollUtil.join(itemIds, ","))
);
// 解析响应
if (!response.getStatusCode().is2xxSuccessful()) {
    // 查询失败,直接结束
    return;
}
List<ItemDTO> items = response.getBody();

if (CollUtils.isEmpty(items)) {
    return;
}
```

# OpenFeign

